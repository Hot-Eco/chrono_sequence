---
title: "Analysis of chrono-sequence data with generalized additive models"
output:
  word_document:
    fig_height: 8
    fig_width: 8
    reference_docx: mystyles.docx
  html_document:
    fig_height: 8
    fig_width: 8
---

```{r setup, message = FALSE, echo = FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE)

library(dplyr)
library(ggplot2)
library(tidyr)
library(mgcv)

library(mxbstuff)

DAT.sites <- read.csv( mdPath("data/sites.csv") )
DAT.predigest <- read.csv( mdPath("data/predigest.csv") )
DAT.digest <- read.csv( mdPath("data/digest.csv") )

DAT <- DAT.sites %>%
  left_join(DAT.predigest ) %>%
  left_join(DAT.digest) %>%
  
  # convert site ID from int to factor
  mutate(fSiteId = factor(siteId)) %>%

  # Make wildfire the reference level for fire type
  mutate(fireType = relevel(fireType, "wildfire")) %>%
  
  # Combine depth and fireType factors into a 4-level factor
  # useful in fitting GAMs
  mutate(dft = interaction(fireType, depth)) %>%
  
  # Add a variable for proportion of carbon that is RPC
  mutate(propRPC = percentRPC / percentC)

# Add an index variable for sites which orders them by fire type. This 
# is handy for summary plots. Indices for wildfire sites come after
# those for prescribed fire sites so that the wildfire observations
# appear in the upper half of the y-axis of summary dot plots.

DAT <- DAT %>%
  distinct(siteId, fireType) %>%
  arrange(desc(fireType), siteId) %>%
  mutate(ftOrder = row_number()) %>% 
  right_join(DAT, by = c("siteId", "fireType"))

# Make sure samples are sorted and add an overall sample 
# index variable
DAT <- DAT %>%
  arrange(siteId, fireType, microsite, depth) %>%
  mutate(sampleIndex = row_number())

NSITES <- nlevels(DAT$fSiteId)


# Useful bits for ggplot

GOPTS <-
  theme_bw() +
  theme(text = element_text(size=20),
        legend.position = "bottom")

POINT_SIZE <- 2
LINE_SIZE <- 1
RIBBON_ALPHA <- 0.3

Labels <- list(
  firetype = "Fire type",
  microsite = "Microsite",
  tsf = "Time since fire (yrs)",
  
  percentC = "% carbon",
  percentRPC = "% RPC",
  propRPC = "RPC proportion",
  percentN = "% nitrogen",
  cnratio = "Carbon / nitrogen ratio",

  sitesFT = "Sites by fire type",
  
  fit = "Fitted values",
  res = "Deviance residuals",
  
  site.by.res = "Sites ordered by mean residual"
)

ZeroLine <- geom_hline(yintercept = 0, linetype = "dashed")

FireTypeColour <- scale_colour_discrete(name = Labels$firetype)


# function to do model predictions and join result to newdata

do_predict <- function(model, newdata, fitname, trfm = identity) {
  p <- predict(model, newdata, type = "response", se.fit = TRUE)
  
  d <- data_frame(
    fit = trfm( p$fit ),
    lwr = trfm( p$fit - 2 * p$se.fit ),
    upr = trfm( p$fit + 2 * p$se.fit )
  )
  
  if (!missing(fitname)) colnames(d)[1] <- fitname
  
  as_data_frame(cbind(newdata, d))
}


# Data for general predictions

DAT.predict <- expand.grid(
  tsf.years = seq(0, max(DAT$tsf.years), length.out = 50),
  fireType = levels(DAT$fireType),
  depth = levels(DAT$depth),
  microsite = levels(DAT$microsite)
)

# Add combined factor for fire type and depth
DAT.predict <- mutate(DAT.predict, dft = interaction(fireType, depth))

# trim prediction data so that time since fire is within 
# observed bounds for each combination of fire type, depth
# and microsite

tsf.limits <- DAT %>%
  group_by(fireType, depth, microsite) %>%
  summarize(tsf0 = min(tsf.years), tsf1 = max(tsf.years))

DAT.predict <- DAT.predict %>%
  left_join(tsf.limits, by = c("fireType", "depth", "microsite")) %>%
  filter(tsf.years >= tsf0, tsf.years <= tsf1) %>%
  select(-tsf0, -tsf1)


# Functions to generate posterior predictions for a gaussian gam:
# rmvn, rparams and postSim
source( mdPath("scripts/post_sim_functions.R") )

```

## Coverage of time since fire

Distribution of time since fire values over design factors:

```{r}

ggplot(data = DAT, aes(x = microsite, y = tsf.years)) +
  geom_point(aes(colour = fireType), 
             position = position_jitterdodge(),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  labs(x = Labels$microsite, y = Labels$tsf) +
  
  GOPTS

```


## Total carbon

### Data exploration

The following dot plot shows percent carbon values for all samples. Sites are ordered by fire type, then site ID value (integer: 1 - 33).

```{r}

ggplot(data = DAT, aes(x = percentC, y = ftOrder)) +
  geom_hline(yintercept = 1:NSITES, colour = "grey80") +
  
  geom_point(aes(colour = fireType), size = POINT_SIZE) +
  FireTypeColour +

  scale_x_continuous(limits = c(0, NA),
                     breaks = c(5, 10, 15, 20), 
                     minor_breaks = NULL) +
  
  scale_y_discrete(breaks = NULL, labels = NULL) +

  labs(x = Labels$percentC, y = Labels$sitesFT) +
  
  GOPTS +
  
  facet_wrap(~ depth)

```

Same data, split by micro-site. Note that 'smooth' micro-site samples are missing for three prescribed fire sites and one wildfire site.

```{r}

last_plot() + 
  facet_grid(depth ~ microsite) +
  
  scale_x_continuous(limits = c(0, NA),
                     breaks = c(10, 20), 
                     minor_breaks = NULL)

```


Distribution of values with respect to fire type and microsite.

```{r}

ggplot(data = DAT, aes(x = microsite, y = percentC)) +
  geom_point(aes(colour = fireType), 
             position = position_jitterdodge(),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  labs(x = Labels$microsite, y = Labels$percentC) +
  
  GOPTS +
  
  facet_wrap(~ depth)

```



Pattern of percent carbon values relative to time since fire.

```{r}

ggplot(data = DAT, aes(x = tsf.years, y = percentC)) +
  geom_point(aes(colour = fireType),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  labs(x = Labels$tsf, y = Labels$percentC) +

  GOPTS +
  
  facet_wrap(~ depth)

```


```{r}

last_plot() +
  facet_grid(depth ~ microsite)

```



### Initial model

We begin with a simple additive model, ignoring the nesting of samples within sites. Micro-site is fitted as a random effect so that we can zero it out when plotting model predictions if desired.

This model includes a smoothed term for time since fire to allow for non-linear effects, with an interaction between time, fire type and depth.

**Note:** We place a conservative upper limit on the number of degrees of freedom for the smooth term for time since fire. This is done because we noticed that in trial models using the default limit on degrees of freedom, the fitted smooth function for time since fire had a pronounced concave-down shape in the interval where data are absent (25-35 years since fire). This was clearly an artefact of the sparse data for longer times since fire. Adding the constraint gives a more parsimonious and credible trend.

The R code to fit this model is:

```{r echo = TRUE}

dat.model <- DAT
dat.model$flag.ms <- 1

mtotalC <- gam(log(percentC) ~ s(tsf.years, by = dft, k=4) + 
                 fireType + depth + 
                 s(microsite, bs = "re", by = flag.ms),
               data = dat.model,
               method = "REML")

```


Examining model residuals...

```{r}

dat <- data_frame(
  resid = resid(mtotalC),
  fitted = fitted(mtotalC)
)

ggplot(data = dat) +
  geom_histogram(aes(x = resid), binwidth = 0.1,
                 fill = "grey80", colour = "black") +
  
  labs(x = Labels$res, y = "count") +
  
  GOPTS

```

Checking residuals for normality:

```{r}

qqnorm(dat$resid, main = "Residuals Q-Q plot")
qqline(dat$resid, lty = 2)

```

Graph of residuals against fitted values to check for homogeneity.

```{r}

dat <- cbind(DAT, dat)

ggplot(data = dat, aes(x = fitted, y = resid)) +
  geom_point(size = POINT_SIZE) +

  ZeroLine +
  
  labs(x = Labels$fit, y = Labels$res) +
  
  GOPTS

```

Residuals against co-variates.

```{r}

ggplot(data = dat, aes(x = tsf.years, y = resid)) +
  geom_point(size = POINT_SIZE) +
  
  ZeroLine +
  
  labs(x = Labels$tsf, y = Labels$res) +

  GOPTS +

  facet_grid(depth ~ fireType)

```

```{r}

ggplot(data = dat, aes(x = fireType, y = resid)) +
  
  geom_point(position = position_jitter(width = 0.15),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  ZeroLine +
  
  labs(x = Labels$firetype, y = Labels$res) +
  
  GOPTS +
  
  facet_wrap( ~ depth)

```

```{r}

ggplot(data = dat, aes(x = microsite, y = resid)) +
  
  geom_point(position = position_jitter(width = 0.15),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  ZeroLine +
  
  labs(x = Labels$microsite, y = Labels$res) +
  
  GOPTS +
  
  facet_wrap( ~ depth)

```

Graph of residuals against sites to check for any systematic patterns and assess our decision to ignore any correlation of responses within sites in the initial model.

To make any pattern easier to see, sites are arranged on the X-axis in ascending order of mean residual value within site.

```{r}

# Order the sites by mean residual value
site.order <- dat %>%
  group_by(fSiteId) %>%
  summarize(rmean = mean(resid)) %>%
  arrange(rmean) %>%
  mutate(order = row_number())

dat.gg <- left_join(dat, site.order)

ggplot(data = dat.gg, aes(x = order, y = resid)) +
  geom_point(size = POINT_SIZE) +
  FireTypeColour +
  
  ZeroLine +
  
  scale_x_discrete(labels = NULL) +
  
  labs(x = Labels$site.by.res, y = Labels$res) +
  
  GOPTS

```

Residuals are not independent across sites. We confirm this by regressing residuals on site:

```{r}

anova(lm(resid ~ fSiteId, data = dat))

```



### Second model incorporating site random effect

Here we add a random-effect smoother to the model to account for site differences. Because the number of sites is small, we take [this approach described by Simon Wood](http://r.789695.n4.nabble.com/mgcv-gamm-predict-to-reflect-random-s-effects-tp3622738p3622865.html) (author of the mgcv package), using the standard `gam` function. A binary flag associated with the random effect smoother is set to 1 to include the random effect for model fitting, and set to 0 to exclude it when making predictions.


```{r echo = TRUE}

dat.model <- DAT
dat.model$flag.site <- 1
dat.model$flag.ms <- 1

mtotalC.site <- gam(log(percentC) ~ s(tsf.years, by = dft, k=4) + 
                     fireType + depth + 
                     s(microsite, bs = "re", by = flag.ms) + 
                     s(fSiteId, bs = "re", by = flag.site),
                   data = dat.model,
                   method = "REML")

```

Once again we graph the residuals against sites ordered in the same manner as before.

```{r}

dat <- cbind(
  dat.model,
  resid = resid(mtotalC.site),
  fitted = fitted(mtotalC.site)
)

site.order <- dat %>%
  group_by(fSiteId) %>%
  summarize(rmean = mean(resid)) %>%
  arrange(rmean) %>%
  mutate(order = row_number())

dat.gg <- left_join(dat, site.order)

ggplot(data = dat.gg, aes(x = order, y = resid)) +
  geom_point(size = POINT_SIZE) +
  ZeroLine +
  
  scale_x_discrete(labels = NULL) +
  
  labs(x = Labels$site.by.res, y = Labels$res) +
  GOPTS

```

Residuals now appear independent across sites.  We confirm this by repeating the regression:

```{r}

anova(lm(resid ~ fSiteId, data = dat))

```

Checking for normality of residuals:

```{r}

qqnorm(dat$resid, main = "Residual Q-Q plot")
qqline(dat$resid)

```

Not great but we'll live with it.

Comparing the two models with AIC:

```{r}

AIC(mtotalC, mtotalC.site)

```

The second model, incorporating site random effects, is clearly preferred.

Summary of the fitted model:

```{r}

summary(mtotalC.site)

```

### Model summary with micro-site as fixed term

Changing micro-site from random to fixed effect gives coefficient estimates for the 'rough' and 'smooth' categories in the model summary. The coefficients for other terms (excepting the intercept) will remain unchanged apart from possible minor jiggle.

```{r}

mtotalC.site.fixms <- gam(log(percentC) ~ s(tsf.years, by = dft, k=4) + 
                            fireType + depth + 
                            microsite + 
                            s(fSiteId, bs = "re", by = flag.site),
                          data = dat.model,
                          method = "REML")

summary(mtotalC.site.fixms)

```


### Model predictions

```{r}

# Add flag variables to turn random site effects off but keep
# random microsite effects.  Also add a dummy site ID 
# (to keep predict.gam happy)

dat.predict <- cbind(
  DAT.predict,
  flag.site = 0,
  flag.ms = 1,
  fSiteId = levels(DAT$fSiteId)[1]
)

```

Predictions taking into account micro-site:

```{r}

fit <- do_predict(mtotalC.site, dat.predict, "percentC", exp)

ggplot(data = fit, aes(x = tsf.years, y = percentC)) +
  geom_point(data = DAT, aes(colour = fireType), size = POINT_SIZE) +
  
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = fireType), 
              alpha = RIBBON_ALPHA) +
  
  geom_line(aes(colour = fireType), size = LINE_SIZE) +
  
  FireTypeColour +
  scale_fill_discrete(name = Labels$firetype) +
  
  labs(x = Labels$tsf, y = Labels$percentC) +
  
  facet_grid(depth ~ microsite, scales = "fixed") +
  GOPTS

```

### Separate figures for graphical abstract

For the the graphical abstract of Robert's paper, we draw graphs of predictions for total carbon in 0-5cm / rough bark tree. There is a separate graph for each fire type.

```{r}

plotfn <- function(dat) {
  ggplot(data = dat, aes(x = tsf.years, y = percentC) ) +
    
    geom_ribbon(aes(ymin = lwr, ymax = upr), 
                alpha = RIBBON_ALPHA) +
    
    geom_line(size = LINE_SIZE) +
    
    xlim(0, 45) +
    ylim(0, 12.5) +
    
    labs(x = "Time since fire (years)", 
         y = "Total mineral soil C (%)") +
    
    theme_bw() +
    theme(text = element_text(size = 24))
}

g <- plotfn( filter(fit, 
                    microsite == "rough",
                    depth == "0-5cm",
                    fireType == "wildfire") )

ggsave("totalC_rough_5cm_wildfire.png", g, 
       width = 6, height = 4, units = "in")

print(g)

```

```{r}

g <- plotfn( filter(fit, 
                    microsite == "rough",
                    depth == "0-5cm",
                    fireType == "prescribed") )

ggsave("totalC_rough_5cm_prescribed.png", g, 
       width = 6, height = 4, units = "in")

print(g)

```



Predictions excluding the effect of micro-site:

```{r}

dat.predict$flag.ms <- 0
fit <- do_predict(mtotalC.site, dat.predict, "percentC", exp)

ggplot(data = fit, aes(x = tsf.years, y = percentC)) +
  geom_point(data = DAT, aes(colour = fireType), size = POINT_SIZE) +
  
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = fireType), 
              alpha = RIBBON_ALPHA) +
  
  geom_line(aes(colour = fireType), size = LINE_SIZE) +
  
  FireTypeColour +
  scale_fill_discrete(name = Labels$firetype) +
  
  labs(x = Labels$tsf, y = Labels$percentC) +
  
  facet_wrap(~ depth, ncol = 1) +
  GOPTS

```

### Predicted difference between fire types

Here we use posterior simulation to generate a set of 1000 credible mean trends from the fitted GAM for total carbon and, for each trend, calculate the difference in carbon between the two fire types.

```{r}

dat.predict$flag.ms <- 1
diffs <- postSim(1000, mtotalC.site.fixms, dat.predict) %>%
  select(-dft, -flag.site, -flag.ms, -fSiteId) %>%
  
  # convert to long format, back-transfrom from log-scale, then back to wide format
  gather(sim, value, -c(tsf.years, fireType, depth, microsite)) %>%
  mutate(value = exp(value)) %>%
  spread(fireType, value) %>%
  
  mutate(diff = wildfire - prescribed) %>%
  
  # subset to time x depth x microsite where both trends are defined
  filter(!is.na(diff)) %>%
  
  # calculate means and bounds for each time
  group_by(depth, microsite, tsf.years) %>%
  
  summarize(meandiff = mean(diff),
            lwr = quantile(diff, 0.025),
            upr = quantile(diff, 0.975))


ggplot(data = diffs, aes(x = tsf.years)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill = "cyan", alpha = 0.4) +
  
  geom_line(aes(y = meandiff), colour = "blue") +
  
  ZeroLine +
  
  labs(x = Labels$tsf, y = "%C (wildfire - prescribed)") +
  
  facet_grid(depth ~ microsite) +
  GOPTS


```


## Recalcitrant pyrogenic carbon

For RPC, we are interested in the absolute value within samples as well as the fraction of total carbon in the form of RPC. Here we begin with a model of the absolute values, controlling for the amount of total carbon in the sample by including that as a co-variate.


### Data exploration

The following dot plot shows percent carbon for all samples. Sites are ordered by fire type, then site ID value (integer: 1 - 33).

```{r}

ggplot(data = DAT, aes(x = percentRPC, y = ftOrder)) +
  geom_hline(yintercept = 1:NSITES, colour = "grey80") +
  
  geom_point(aes(colour = fireType), size = POINT_SIZE) +
  
  FireTypeColour +
  
  scale_x_continuous(limits = c(0, NA),
                     breaks = waiver(), 
                     minor_breaks = NULL) +
  
  scale_y_discrete(breaks = NULL, labels = NULL) +
  
  labs(x = Labels$percentRPC, y = Labels$sitesFT) +
  
  GOPTS +
  
  facet_wrap(~ depth)

```


```{r}

last_plot() + 
  facet_grid(depth ~ microsite)

```


Distribution of values with respect to fire type and microsite.

```{r}

ggplot(data = DAT, aes(x = microsite, y = percentRPC)) +
  geom_point(aes(colour = fireType), 
             position = position_jitterdodge(),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  labs(x = Labels$microsite, y = Labels$percentRPC) +
  
  GOPTS +
  
  facet_wrap(~ depth)

```



Relative to time since fire.

```{r}

ggplot(data = DAT, aes(x = tsf.years, y = percentRPC)) +
  geom_point(aes(colour = fireType),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  labs(x = Labels$tsf, y = Labels$percentRPC) +

  GOPTS +
  
  facet_wrap(~ depth)

```


```{r}

last_plot() +
  facet_grid(depth ~ microsite)

```


### Model

The form of the model follows that used for total carbon as the response, the only modification being the inclusion of total carbon as a co-variate to control for its effect on the level of recalcitrant carbon.

**Note:** we place the same constraint on the degrees of freedom available for the smooth term for time since fire as was done with the total carbon model.

```{r echo = TRUE}

dat.model <- DAT
dat.model$flag.site <- 1
dat.model$flag.ms <- 1

mrpc <- gam(log(percentRPC) ~ s(tsf.years, by = dft, k=4) + 
              fireType + depth +
              s(log(percentC)) +
              s(microsite, bs = "re", by = flag.ms) +
              s(fSiteId, bs = "re", by = flag.site),
            data = dat.model,
            method = "REML")

```

Check residuals against sites ordered in the same manner as for the percent carbon model.

```{r}

dat <- cbind(
  dat.model,
  resid = resid(mrpc),
  fitted = fitted(mrpc)
)

site.order <- dat %>%
  group_by(fSiteId) %>%
  summarize(rmean = mean(resid)) %>%
  arrange(rmean) %>%
  mutate(order = row_number())

dat.gg <- left_join(dat, site.order)

ggplot(data = dat.gg, aes(x = order, y = resid)) +
  geom_point(size = POINT_SIZE) +
  ZeroLine +
  
  scale_x_discrete(labels = NULL) +
  
  labs(x = Labels$site.by.res, y = Labels$res) +
  GOPTS

```

No obvious pattern of residuals across sites. Check with anova:

```{r}

anova(lm(resid ~ fSiteId, data = dat))

```

Checking for normality of residuals:

```{r}

qqnorm(dat$resid, main = "Residual Q-Q plot")
qqline(dat$resid)

```

All looks good except for the single sample with a large negative value. Investigating this sample:

```{r}

outlier <- filter(dat, resid < -4) %>%
  select(siteId, fireType, depth, microsite) %>%
  left_join(DAT) %>%
  select(sampleIndex, siteLabel, fireType, depth, microsite, tsf.years, percentC, percentRPC)

knitr::kable(outlier)

```


The offender is sample number 166. Its value of RPC is very low compared to the other two replicates. Checked with Robert and he suggests that this was most likely a problem with the digestion. The sample will have had little influence on the model, but to be safe we discard it and re-run...

```{r echo = TRUE}

DAT <- filter(DAT, sampleIndex != 166)

dat.model <- DAT
dat.model$flag.ms <- 1
dat.model$flag.site <- 1

mrpc <- gam(log(percentRPC) ~ s(tsf.years, by = dft, k=4) + 
            fireType + depth +
            s(log(percentC)) +
            s(microsite, bs = "re", by = flag.ms) +
            s(fSiteId, bs = "re", by = flag.site),
          data = dat.model,
          method = "REML")

```

Re-check the residuals:

```{r}

dat <- cbind(
  dat.model,
  resid = resid(mrpc),
  fitted = fitted(mrpc)
)

qqnorm(dat$resid, main = "Residual Q-Q plot")
qqline(dat$resid)

```


Summary of the fitted model:

```{r}

summary(mrpc)

```

### Shape of the effect of total carbon

Total carbon (log-transformed) was fitted as a smooth term. Its estimated degrees of freedom (~ 2.8) indicate only a slight departure from linear. The graph below shows the shape of the fitted smooth function:

```{r}

plot(mrpc, select = 5)

```


### Model summary with micro-site as fixed term

Changing micro-site from random to fixed effect gives coefficient estimates for the 'rough' and 'smooth' categories in the model summary. The coefficients for other terms (excepting the intercept) will remain unchanged apart from possible minor jiggle.

```{r}

mrpc.fixms <- gam(log(percentRPC) ~ s(tsf.years, by = dft, k=4) + 
                    fireType + depth +
                    s(log(percentC)) +
                    microsite +
                    s(fSiteId, bs = "re", by = flag.site),
                  data = dat.model,
                  method = "REML")

summary(mrpc.fixms)

```


### Model predictions

Predictions including micro-site effects.

Within each combination of fire type, depth and micro-site, we derive predictions over times since fire based on the median value of total carbon. 


```{r}

dat.predict <- cbind(
  DAT.predict,
  flag.ms = 1,
  flag.site = 0,
  fSiteId = levels(DAT$fSiteId)[1]
)

Cmeans <- DAT %>%
  group_by(fireType, depth, microsite) %>%
  summarize(percentC = median(percentC))

dat.predict <- left_join(dat.predict, Cmeans)

fit <- do_predict(mrpc, dat.predict, "percentRPC", exp)

ggplot(data = fit, aes(x = tsf.years, y = percentRPC)) +
  geom_point(data = DAT, aes(colour = fireType), size = POINT_SIZE) +
  
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = fireType),
              alpha = RIBBON_ALPHA) +
  
  geom_line(aes(colour = fireType), size = LINE_SIZE) +
  
  FireTypeColour +
  scale_fill_discrete(name = Labels$firetype) +
  
  labs(x = Labels$tsf, y = Labels$percentRPC) +
  
  facet_grid(depth ~ microsite) +
  GOPTS

```

Predictions excluding micro-site effects.

For calculations here, we use the median value of total carbon within combinations of fire type and depth.

```{r}

dat.predict <- cbind(
  DAT.predict,
  flag.ms = 0,
  flag.site = 0,
  fSiteId = levels(DAT$fSiteId)[1]
)

Cmeans <- DAT %>%
  group_by(fireType, depth) %>%
  summarize(percentC = median(percentC))

dat.predict <- left_join(dat.predict, Cmeans)

fit <- do_predict(mrpc, dat.predict, "percentRPC", exp)

ggplot(data = fit, aes(x = tsf.years, y = percentRPC)) +
  geom_point(data = DAT, aes(colour = fireType), size = POINT_SIZE) +
  
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = fireType), 
              alpha = RIBBON_ALPHA) +
  
  geom_line(aes(colour = fireType), size = LINE_SIZE) +
  
  FireTypeColour +
  scale_fill_discrete(name = Labels$firetype) +
  
  labs(x = Labels$tsf, y = Labels$percentRPC) +
  
  facet_wrap(~ depth, ncol = 1) +
  GOPTS

```


### Predicted difference between fire types

Predicted difference in %RPC between the two fire types based on posterior simulation.

```{r}

dat.predict <- cbind(
  DAT.predict,
  flag.ms = 1,
  flag.site = 0,
  fSiteId = levels(DAT$fSiteId)[1]
)

Cmeans <- DAT %>%
  group_by(fireType, depth, microsite) %>%
  summarize(percentC = median(percentC))

dat.predict <- left_join(dat.predict, Cmeans)

diffs <- postSim(1000, mrpc.fixms, dat.predict) %>%
  select(-dft, -flag.site, -flag.ms, -fSiteId, -percentC) %>%
  
  # convert to long format, back-transfrom from log-scale, then back to wide format
  gather(sim, value, -c(tsf.years, fireType, depth, microsite)) %>%
  mutate(value = exp(value)) %>%
  spread(fireType, value) %>%
  
  mutate(diff = wildfire - prescribed) %>%
  
  # subset to time x depth x microsite where both trends are defined
  filter(!is.na(diff)) %>%
  
  # calculate means and bounds for each time
  group_by(depth, microsite, tsf.years) %>%
  
  summarize(meandiff = mean(diff),
            lwr = quantile(diff, 0.025),
            upr = quantile(diff, 0.975))


ggplot(data = diffs, aes(x = tsf.years)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill = "cyan", alpha = 0.4) +
  
  geom_line(aes(y = meandiff), colour = "blue") +
  
  ZeroLine +
  
  labs(x = Labels$tsf, y = "%RPC (wildfire - prescribed)") +
  
  facet_grid(depth ~ microsite) +
  GOPTS


```

## Proportion of recalcitrant pyrogenic carbon

Here we fit a similar model, but with the response being RPC as a proportion of total carbon.

### Data exploration

```{r}

ggplot(data = DAT, aes(x = propRPC, y = ftOrder)) +
  geom_hline(yintercept = 1:NSITES, colour = "grey80") +
  
  geom_point(aes(colour = fireType), size = POINT_SIZE) +
  
  FireTypeColour +
  
  scale_x_continuous(limits = c(0, NA),
                     breaks = waiver(), 
                     minor_breaks = NULL) +
  
  scale_y_discrete(breaks = NULL, labels = NULL) +
  
  labs(x = Labels$propRPC, y = Labels$sitesFT) +
  
  GOPTS +
  
  facet_wrap(~ depth)

```


```{r}

last_plot() + 
  facet_grid(depth ~ microsite)

```


Distribution of values with respect to fire type and microsite.

```{r}

ggplot(data = DAT, aes(x = microsite, y = propRPC)) +
  geom_point(aes(colour = fireType), 
             position = position_jitterdodge(),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  labs(x = Labels$microsite, y = Labels$propRPC) +
  
  GOPTS +
  
  facet_wrap(~ depth)

```



Relative to time since fire.

```{r}

ggplot(data = DAT, aes(x = tsf.years, y = propRPC)) +
  geom_point(aes(colour = fireType),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  labs(x = Labels$tsf, y = Labels$propRPC) +

  GOPTS +
  
  facet_wrap(~ depth)

```


```{r}

last_plot() +
  facet_grid(depth ~ microsite)

```

### Model

As before, we place a constraint on the degrees of freedom for the smooth term for time since fire.

```{r echo = TRUE}

dat.model <- DAT
dat.model$flag.ms <- 1
dat.model$flag.site <- 1

mrpc.prop <- gam(log(propRPC) ~ s(tsf.years, by = dft, k=4) + 
                   fireType + depth +
                   s(microsite, bs = "re", by = flag.ms) +
                   s(fSiteId, bs = "re", by = flag.site),
                 data = dat.model,
                 method = "REML")

```


Check residuals against sites ordered in the same manner as for the percent carbon model.

```{r}

dat <- cbind(
  dat.model,
  resid = resid(mrpc.prop),
  fitted = fitted(mrpc.prop)
)

site.order <- dat %>%
  group_by(fSiteId) %>%
  summarize(rmean = mean(resid)) %>%
  arrange(rmean) %>%
  mutate(order = row_number())

dat.gg <- left_join(dat, site.order)

ggplot(data = dat.gg, aes(x = order, y = resid)) +
  geom_point(size = POINT_SIZE) +
  ZeroLine +
  
  scale_x_discrete(labels = NULL) +
  
  labs(x = Labels$site.by.res, y = Labels$res) +
  GOPTS

```

Checking for normality of residuals:

```{r}

qqnorm(dat$resid, main = "Residual Q-Q plot")
qqline(dat$resid)

```

Summary of the fitted model:

```{r}

summary(mrpc.prop)

```

### Model summary with micro-site as fixed term

Changing micro-site from random to fixed effect gives coefficient estimates for the 'rough' and 'smooth' categories in the model summary. The coefficients for other terms (excepting the intercept) will remain unchanged apart from possible minor jiggle.

```{r}

mrpc.prop.fixms <- gam(log(propRPC) ~ s(tsf.years, by = dft, k=4) + 
                         fireType + depth +
                         microsite +
                         s(fSiteId, bs = "re", by = flag.site),
                       data = dat.model,
                       method = "REML")

summary(mrpc.prop.fixms)

```


### Model predictions

Including micro-site random effects:

```{r}

dat.predict <- cbind(
  DAT.predict,
  flag.ms = 1,
  flag.site = 0,
  fSiteId = levels(DAT$fSiteId)[1]
)

fit <- do_predict(mrpc.prop, dat.predict, "propRPC", exp)

ggplot(data = fit, aes(x = tsf.years, y = propRPC)) +
  geom_point(data = DAT, aes(colour = fireType), size = POINT_SIZE) +
  
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = fireType), 
              alpha = RIBBON_ALPHA) +
  
  geom_line(aes(colour = fireType), size = LINE_SIZE) +
  
  FireTypeColour +
  scale_fill_discrete(name = Labels$firetype) +
  
  labs(x = Labels$tsf, y = Labels$propRPC) +
  
  facet_grid(depth ~ microsite) +
  GOPTS

```

Excluding micro-site random effects:

```{r}

dat.predict$flag.ms <- 0

fit <- do_predict(mrpc.prop, dat.predict, "propRPC", exp)

ggplot(data = fit, aes(x = tsf.years, y = propRPC)) +
  geom_point(data = DAT, aes(colour = fireType), size = POINT_SIZE) +
  
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = fireType), 
              alpha = RIBBON_ALPHA) +

  geom_line(aes(colour = fireType), size = LINE_SIZE) +
  
  FireTypeColour +
  scale_fill_discrete(name = Labels$firetype) +
  
  labs(x = Labels$tsf, y = Labels$propRPC) +
  
  facet_wrap(~ depth, ncol = 1) +
  GOPTS

```


### Predicted difference between fire types

Predicted difference in RPC proportion between the two fire types based on posterior simulation.

```{r}

diffs <- postSim(1000, mrpc.prop.fixms, dat.predict) %>%
  select(-dft, -flag.site, -flag.ms, -fSiteId) %>%
  
  # convert to long format, back-transfrom from log-scale, then back to wide format
  gather(sim, value, -c(tsf.years, fireType, depth, microsite)) %>%
  mutate(value = exp(value)) %>%
  spread(fireType, value) %>%
  
  mutate(diff = wildfire - prescribed) %>%
  
  # subset to time x depth x microsite where both trends are defined
  filter(!is.na(diff)) %>%
  
  # calculate means and bounds for each time
  group_by(depth, microsite, tsf.years) %>%
  
  summarize(meandiff = mean(diff),
            lwr = quantile(diff, 0.025),
            upr = quantile(diff, 0.975))

ggplot(data = diffs, aes(x = tsf.years)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill = "cyan", alpha = 0.4) +
  
  geom_line(aes(y = meandiff), colour = "blue") +
  
  ZeroLine +
  
  labs(x = Labels$tsf, y = "RPC prop (wildfire - prescribed)") +
  
  facet_grid(depth ~ microsite) +
  GOPTS


```


## Total nitrogen

### Data exploration

The following dot plot shows percent nitrogen values for all samples. Sites are ordered by fire type, then site ID value (integer: 1 - 33).

```{r}

ggplot(data = DAT, aes(x = percentN, y = ftOrder)) +
  geom_hline(yintercept = 1:NSITES, colour = "grey80") +
  
  geom_point(aes(colour = fireType), size = POINT_SIZE) +
  FireTypeColour +

  scale_x_continuous(limits = c(0, NA),
                     breaks = c(5, 10, 15, 20), 
                     minor_breaks = NULL) +
  
  scale_y_discrete(breaks = NULL, labels = NULL) +

  labs(x = Labels$percentN, y = Labels$sitesFT) +
  
  GOPTS +
  
  facet_wrap(~ depth)

```

Same data, split by micro-site. Note that 'smooth' micro-site samples are missing for three prescribed fire sites and one wildfire site.

```{r}

last_plot() + 
  facet_grid(depth ~ microsite) +
  
  scale_x_continuous(limits = c(0, NA),
                     breaks = c(10, 20), 
                     minor_breaks = NULL)

```


Distribution of values with respect to fire type and microsite.

```{r}

ggplot(data = DAT, aes(x = microsite, y = percentN)) +
  geom_point(aes(colour = fireType), 
             position = position_jitterdodge(),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  labs(x = Labels$microsite, y = Labels$percentN) +
  
  GOPTS +
  
  facet_wrap(~ depth)

```



Pattern of percent nitrogen values relative to time since fire.

```{r}

ggplot(data = DAT, aes(x = tsf.years, y = percentN)) +
  geom_point(aes(colour = fireType),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  labs(x = Labels$tsf, y = Labels$percentN) +

  GOPTS +
  
  facet_wrap(~ depth)

```


```{r}

last_plot() +
  facet_grid(depth ~ microsite)

```



### Model

We model total nitrogen using the same approach that proved most informative for carbon. The model includes:

* a smooth term for the interaction between time since fire, depth and fire type;

* fixed categorical terms for fire type, depth and micro-site;

* a random effect for site.

We use a Normal distribution with identity link function. Reponse values are log-transformed.

As for the carbon models, we constrain the degrees of freedom for the smooth term for time since fire.

```{r echo = TRUE}

dat.model <- DAT
dat.model$flag.site <- 1

mtotalN.site <- gam(log(percentN) ~ s(tsf.years, by = dft, k=4) + 
                     fireType + depth + 
                     microsite + 
                     s(fSiteId, bs = "re", by = flag.site),
                   data = dat.model,
                   method = "REML")

```


Graph of residuals against sites to check the performance of the random effect term. 

```{r}

dat <- cbind(
  dat.model,
  resid = resid(mtotalN.site),
  fitted = fitted(mtotalN.site)
)

site.order <- dat %>%
  group_by(fSiteId) %>%
  summarize(rmean = mean(resid(mtotalN.site))) %>%
  arrange(rmean) %>%
  mutate(order = row_number())

dat.gg <- left_join(dat, site.order)

ggplot(data = dat.gg, aes(x = order, y = resid)) +
  geom_point(size = POINT_SIZE) +
  ZeroLine +
  
  scale_x_discrete(labels = NULL) +
  
  labs(x = Labels$site.by.res, y = Labels$res) +
  GOPTS

```

No systematic pattern is evident. However, there is one outlier:

```{r}

x <- filter(dat, resid < -1) %>%
  select(siteId, fireType, depth, microsite) %>%
  left_join(dat) %>%
  select(siteLabel, siteId, fireType, depth, microsite, rep, percentN, fitted) %>%
  mutate(fitted = exp(fitted))

knitr::kable(x)

```

Replicate number 1 has a somewhat lower value for total nitrogen that the other two replicates.


Further model validation...

Distribution of residuals:

```{r}

ggplot(data = dat) +
  geom_histogram(aes(x = resid), binwidth = 0.1,
                 fill = "grey80", colour = "black") +
  
  labs(x = Labels$res, y = "count") +
  
  GOPTS

```

Checking for normality of residuals:

```{r}

qqnorm(dat$resid, main = "Residual Q-Q plot")
qqline(dat$resid)

```

Ignoring the outlier, there is some departure at the tails but nothing dramatic.


Graph of residuals against fitted values to check for homogeneity.

```{r}

ggplot(data = dat, aes(x = fitted, y = resid)) +
  geom_point(size = POINT_SIZE) +

  ZeroLine +
  
  labs(x = Labels$fit, y = Labels$res) +
  
  GOPTS

```

Residuals against co-variates.

```{r}

ggplot(data = dat, aes(x = tsf.years, y = resid)) +
  geom_point(size = POINT_SIZE) +
  
  ZeroLine +
  
  labs(x = Labels$tsf, y = Labels$res) +

  GOPTS +

  facet_grid(depth ~ fireType)

```

```{r}

ggplot(data = dat, aes(x = fireType, y = resid)) +
  
  geom_point(position = position_jitter(width = 0.15),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  ZeroLine +
  
  labs(x = Labels$firetype, y = Labels$res) +
  
  GOPTS +
  
  facet_wrap( ~ depth)

```

```{r}

ggplot(data = dat, aes(x = microsite, y = resid)) +
  
  geom_point(position = position_jitter(width = 0.15),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  ZeroLine +
  
  labs(x = Labels$microsite, y = Labels$res) +
  
  GOPTS +
  
  facet_wrap( ~ depth)

```

Response against fitted values:

```{r}

ggplot(data = dat, aes(x = exp(fitted), y = percentN)) +
  geom_point(size = POINT_SIZE, alpha = 0.5) +
  
  geom_abline(intercept = 0, slope = 1, linetype = "dashed") +
  
  labs(x = Labels$fit, y = Labels$percentN) +
  GOPTS

```

The model under-predicts for a group of samples with atypically high nitrogen values (> 0.4%). The samples in question are a group of three replicates:

```{r}

x <- filter(dat, percentN > 0.4) %>%
  select(siteId, fireType, depth, microsite) %>%
  left_join(dat) %>%
  select(siteLabel, siteId, fireType, depth, microsite, rep, percentN, fitted) %>%
  mutate(fitted = exp(fitted)) %>%
  distinct()

knitr::kable(x)

```


### Model summary

```{r}

summary(mtotalN.site)

```


### Model predictions

```{r}

dat.predict <- cbind(
  DAT.predict,
  flag.site = 0,
  fSiteId = levels(DAT$fSiteId)[1]
)

```


```{r}

fit <- do_predict(mtotalN.site, dat.predict, "percentN", exp)

ggplot(data = fit, aes(x = tsf.years, y = percentN)) +
  geom_point(data = DAT, aes(colour = fireType), size = POINT_SIZE) +
  
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = fireType), 
              alpha = RIBBON_ALPHA) +
  
  geom_line(aes(colour = fireType), size = LINE_SIZE) +
  
  FireTypeColour +
  scale_fill_discrete(name = Labels$firetype) +
  
  labs(x = Labels$tsf, y = Labels$percentN) +
  
  facet_grid(depth ~ microsite, scales = "fixed") +
  GOPTS

```



### Predicted difference between fire types

Here we use posterior simulation to generate a set of 1000 credible mean trends from the fitted GAM for total nitrogen and, for each trend, calculate the difference in nitrogen between the two fire types.

```{r}

diffs <- postSim(1000, mtotalN.site, dat.predict) %>%
  select(-dft, -flag.site, -fSiteId) %>%
  
  # convert to long format, back-transfrom from log-scale, then back to wide format
  gather(sim, value, -c(tsf.years, fireType, depth, microsite)) %>%
  mutate(value = exp(value)) %>%
  spread(fireType, value) %>%
  
  mutate(diff = wildfire - prescribed) %>%
  
  # subset to time x depth x microsite where both trends are defined
  filter(!is.na(diff)) %>%
  
  # calculate means and bounds for each time
  group_by(depth, microsite, tsf.years) %>%
  
  summarize(meandiff = mean(diff),
            lwr = quantile(diff, 0.025),
            upr = quantile(diff, 0.975))


ggplot(data = diffs, aes(x = tsf.years)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill = "cyan", alpha = 0.4) +
  
  geom_line(aes(y = meandiff), colour = "blue") +
  
  ZeroLine +
  
  labs(x = Labels$tsf, y = "%C (wildfire - prescribed)") +
  
  facet_grid(depth ~ microsite) +
  GOPTS


```


## Carbon to nitrogen ratio

### Model

```{r echo = TRUE}

dat.model <- DAT %>%
  mutate(cnratio = percentC / percentN)

dat.model$flag.site <- 1

mratio <- gam(log(cnratio) ~ s(tsf.years, by = dft, k=4) + 
                     fireType + depth + 
                     microsite + 
                     s(fSiteId, bs = "re", by = flag.site),
                   data = dat.model,
                   method = "REML")


```


Distribution of residuals:

```{r}

dat <- cbind(
  dat.model,
  resid = resid(mratio),
  fitted = fitted(mratio)
)

ggplot(data = dat) +
  geom_histogram(aes(x = resid), binwidth = 0.1,
                 fill = "grey80", colour = "black") +
  
  labs(x = Labels$res, y = "count") +
  
  GOPTS

```

Checking for normality of residuals:

```{r}

qqnorm(dat$resid, main = "Residual Q-Q plot")
qqline(dat$resid)

```

The behaviour at the tails looks more like systematic departure from normality rather than just random wiggle. To address this, we try re-fitting the model with a scaled-t (heavy tailed) distribution.

**Note: this was also done the model of C:N ratio in the Eden soils data.**


```{r echo = TRUE}

mratio <- gam(log(cnratio) ~ s(tsf.years, by = dft, k=4) + 
                     fireType + depth + 
                     microsite + 
                     s(fSiteId, bs = "re", by = flag.site),
                   data = dat.model,
                   family = scat(),
                   method = "REML")


```


Re-checking the distribution of residuals:

```{r}

dat <- cbind(
  dat.model,
  resid = resid(mratio),
  fitted = fitted(mratio)
)

qqnorm(dat$resid, main = "Residual Q-Q plot")
qqline(dat$resid)

```

That looks a bit better.

Graph of residuals against fitted values to check for homogeneity.

```{r}

ggplot(data = dat, aes(x = fitted, y = resid)) +
  geom_point(size = POINT_SIZE) +

  ZeroLine +
  
  labs(x = Labels$fit, y = Labels$res) +
  
  GOPTS

```

Residuals against co-variates.

```{r}

ggplot(data = dat, aes(x = tsf.years, y = resid)) +
  geom_point(size = POINT_SIZE) +
  
  ZeroLine +
  
  labs(x = Labels$tsf, y = Labels$res) +

  GOPTS +

  facet_grid(depth ~ fireType)

```

```{r}

ggplot(data = dat, aes(x = fireType, y = resid)) +
  
  geom_point(position = position_jitter(width = 0.15),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  ZeroLine +
  
  labs(x = Labels$firetype, y = Labels$res) +
  
  GOPTS +
  
  facet_wrap( ~ depth)

```

```{r}

ggplot(data = dat, aes(x = microsite, y = resid)) +
  
  geom_point(position = position_jitter(width = 0.15),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  ZeroLine +
  
  labs(x = Labels$microsite, y = Labels$res) +
  
  GOPTS +
  
  facet_wrap( ~ depth)

```

Response against fitted values:

```{r}

ggplot(data = dat, aes(x = exp(fitted), y = cnratio)) +
  geom_point(size = POINT_SIZE, alpha = 0.5) +
  
  geom_abline(intercept = 0, slope = 1, linetype = "dashed") +
  
  labs(x = Labels$fit, y = Labels$cnratio) +
  GOPTS

```

Investigating the outlier:

```{r}

x <- filter(dat, cnratio > 160) %>%
  select(siteLabel, siteId, fireType, depth, microsite, rep, percentC, percentN, cnratio)

knitr::kable(x)

```

This is the same sample that showed up as an outlier in the total nitrogen model. 

**Perhaps discard this sample and re-fit both models? Unlikely that the outlier is having much influence on the overall fit.**

### Model summary

```{r}

summary(mratio)

```

### Model predictions

```{r}

dat.predict <- cbind(
  DAT.predict,
  flag.site = 0,
  fSiteId = levels(DAT$fSiteId)[1]
)


fit <- do_predict(mratio, dat.predict, "cnratio", exp)

ggplot(data = fit, aes(x = tsf.years, y = cnratio)) +
  geom_point(data = dat.model, aes(colour = fireType), size = POINT_SIZE) +
  
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = fireType), 
              alpha = RIBBON_ALPHA) +
  
  geom_line(aes(colour = fireType), size = LINE_SIZE) +
  
  FireTypeColour +
  scale_fill_discrete(name = Labels$firetype) +
  
  labs(x = Labels$tsf, y = Labels$cnratio) +
  
  facet_grid(depth ~ microsite, scales = "fixed") +
  GOPTS

```


### Predicted difference between fire types

Here we use posterior simulation to generate a set of 1000 credible mean trends from the fitted GAM and, for each trend, calculate the difference in carbon to nitrogen ratio between the two fire types.

```{r}

diffs <- postSim(1000, mratio, dat.predict) %>%
  select(-dft, -flag.site, -fSiteId) %>%
  
  # convert to long format, back-transfrom from log-scale, then back to wide format
  gather(sim, value, -c(tsf.years, fireType, depth, microsite)) %>%
  mutate(value = exp(value)) %>%
  spread(fireType, value) %>%
  
  mutate(diff = wildfire - prescribed) %>%
  
  # subset to time x depth x microsite where both trends are defined
  filter(!is.na(diff)) %>%
  
  # calculate means and bounds for each time
  group_by(depth, microsite, tsf.years) %>%
  
  summarize(meandiff = mean(diff),
            lwr = quantile(diff, 0.025),
            upr = quantile(diff, 0.975))


ggplot(data = diffs, aes(x = tsf.years)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill = "cyan", alpha = 0.4) +
  
  geom_line(aes(y = meandiff), colour = "blue") +
  
  ZeroLine +
  
  labs(x = Labels$tsf, y = "%C (wildfire - prescribed)") +
  
  facet_grid(depth ~ microsite) +
  GOPTS


```


## Tabulated predictions for models

Here we tabulate predictions over coarser time increments and save to CSV files to be put into Excel.

```{r}

# Prediction data
dat <- expand.grid(
  tsf.years = c(0.5, 1, seq(5, max(DAT$tsf.years), 5) ),
  fireType = levels(DAT$fireType),
  depth = levels(DAT$depth),
  microsite = levels(DAT$microsite)
) 

dat <- dat %>%
  mutate(dft = interaction(fireType, depth)) %>%
  
  # trim to observed time series for each combination
  left_join(tsf.limits, by = c("fireType", "depth", "microsite")) %>%
  filter(tsf.years >= tsf0, tsf.years <= tsf1) %>%
  select(-tsf0, -tsf1) %>%
  
  # add random effect flag
  mutate(flag.site = 0,
         fSiteId = levels(DAT$fSiteId)[1] )

# Total carbon
fit <- do_predict(mtotalC.site.fixms, dat, "percentC", exp)
write.csv(fit, file = "totalc.csv", row.names = FALSE)

# Recalcitrant carbon
Cmeans <- DAT %>%
  group_by(fireType, depth, microsite) %>%
  summarize(percentC = median(percentC))

dat <- left_join(dat, Cmeans)

fit <- do_predict(mrpc.fixms, dat, "percentRPC", exp)
write.csv(fit, file = "rpc.csv", row.names = FALSE)

# Nitrogen
fit <- do_predict(mtotalN.site, dat, "percentN", exp)
write.csv(fit, file = "totaln.csv", row.names = FALSE)

# C:N ratio
fit <- do_predict(mratio, dat, "cnratio", exp)
write.csv(fit, file = "cnratio.csv", row.names = FALSE)

```

