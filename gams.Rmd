---
title: "Analysis of chrono-sequence data with generalized additive models"
output:
  word_document:
    fig_height: 8
    fig_width: 8
  html_document:
    fig_height: 8
    fig_width: 8
---

```{r setup, message = FALSE, echo = FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE)

library(dplyr)
library(ggplot2)
library(tidyr)
library(mgcv)

DAT.sites <- read.csv("data/sites.csv")
DAT.predigest <- read.csv("data/predigest.csv")
DAT.digest <- read.csv("data/digest.csv")

DAT <- DAT.sites %>%
  left_join(DAT.predigest ) %>%
  left_join(DAT.digest) %>%
  
  # convert site ID from int to factor
  mutate(fSiteId = factor(siteId)) %>%

  # Make wildfire the reference level for fire type
  mutate(fireType = relevel(fireType, "wildfire")) %>%
  
  # Combine depth and fireType factors into a 4-level factor
  # useful in fitting GAMs
  mutate(dft = interaction(fireType, depth)) %>%
  
  # Add a variable for proportion of carbon that is RPC
  mutate(propRPC = percentRPC / percentC)

# Add an index variable for sites which orders them by fire type. This 
# is handy for summary plots. Indices for wildfire sites come after
# those for prescribed fire sites so that the wildfire observations
# appear in the upper half of the y-axis of summary dot plots.

DAT <- DAT %>%
  distinct(siteId, fireType) %>%
  arrange(desc(fireType), siteId) %>%
  mutate(ftOrder = row_number()) %>% 
  right_join(DAT, by = c("siteId", "fireType"))

# Make sure samples are sorted and add an overall sample 
# index variable
DAT <- DAT %>%
  arrange(siteId, fireType, microsite, depth) %>%
  mutate(sampleIndex = row_number())

NSITES <- nlevels(DAT$fSiteId)


# Useful bits for ggplot

GOPTS <-
  theme_bw() +
  theme(text = element_text(size=20),
        legend.position = "bottom")

POINT_SIZE <- 2

Labels <- list(
  firetype = "Fire type",
  percentC = "% carbon",
  percentRPC = "% RPC",
  propRPC = "RPC proportion",
  microsite = "Microsite",
  tsf = "Time since fire (yrs)",
  
  sitesFT = "Sites by fire type",
  
  fit = "Fitted values",
  res = "Deviance residuals",
  
  site.by.res = "Sites ordered by mean residual"
)

ZeroLine <- geom_hline(yintercept = 0, linetype = "dashed")

FireTypeColour <- scale_colour_discrete(name = Labels$firetype)


# function to do model predictions and join result to newdata

do_predict <- function(model, newdata, fitname, trfm = identity) {
  p <- predict(model, newdata, type = "response", se.fit = TRUE)
  
  d <- data_frame(
    fit = trfm( p$fit ),
    lwr = trfm( p$fit - 2 * p$se.fit ),
    upr = trfm( p$fit + 2 * p$se.fit )
  )
  
  if (!missing(fitname)) colnames(d)[1] <- fitname
  
  as_data_frame(cbind(newdata, d))
}


# Data for general predictions

DAT.predict <- expand.grid(
  tsf.years = seq(0, max(DAT$tsf.years), length.out = 50),
  fireType = levels(DAT$fireType),
  depth = levels(DAT$depth),
  microsite = levels(DAT$microsite)
)

# Add combined factor for fire type and depth
DAT.predict <- mutate(DAT.predict, dft = interaction(fireType, depth))

# trim prediction data so that time since fire is within 
# observed bounds for each combination of fire type, depth
# and microsite

tsf.limits <- DAT %>%
  group_by(fireType, depth, microsite) %>%
  summarize(tsf0 = min(tsf.years), tsf1 = max(tsf.years))

DAT.predict <- DAT.predict %>%
  left_join(tsf.limits, by = c("fireType", "depth", "microsite")) %>%
  filter(tsf.years >= tsf0, tsf.years <= tsf1) %>%
  select(-tsf0, -tsf1)

```

## Coverage of time since fire

Distribution of time since fire values over design factors:

```{r}

ggplot(data = DAT, aes(x = microsite, y = tsf.years)) +
  geom_point(aes(colour = fireType), 
             position = position_jitterdodge(),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  labs(x = Labels$microsite, y = Labels$tsf) +
  
  GOPTS

```


## Total carbon

### Data exploration

The following dot plot shows percent carbon values for all samples. Sites are ordered by fire type, then site ID value (integer: 1 - 33).

```{r}

ggplot(data = DAT, aes(x = percentC, y = ftOrder)) +
  geom_hline(yintercept = 1:NSITES, colour = "grey80") +
  
  geom_point(aes(colour = fireType), size = POINT_SIZE) +
  FireTypeColour +

  scale_x_continuous(limits = c(0, NA),
                     breaks = c(5, 10, 15, 20), 
                     minor_breaks = NULL) +
  
  scale_y_discrete(breaks = NULL, labels = NULL) +

  labs(x = Labels$percentC, y = Labels$sitesFT) +
  
  GOPTS +
  
  facet_wrap(~ depth)

```

Same data, split by micro-site. Note that 'smooth' micro-site samples are missing for three prescribed fire sites and one wildfire site.

```{r}

last_plot() + 
  facet_grid(depth ~ microsite) +
  
  scale_x_continuous(limits = c(0, NA),
                     breaks = c(10, 20), 
                     minor_breaks = NULL)

```


Distribution of values with respect to fire type and microsite.

```{r}

ggplot(data = DAT, aes(x = microsite, y = percentC)) +
  geom_point(aes(colour = fireType), 
             position = position_jitterdodge(),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  labs(x = Labels$microsite, y = Labels$percentC) +
  
  GOPTS +
  
  facet_wrap(~ depth)

```



Pattern of percent carbon values relative to time since fire.

```{r}

ggplot(data = DAT, aes(x = tsf.years, y = percentC)) +
  geom_point(aes(colour = fireType),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  labs(x = Labels$tsf, y = Labels$percentC) +

  GOPTS +
  
  facet_wrap(~ depth)

```


```{r}

last_plot() +
  facet_grid(depth ~ microsite)

```



### Initial model

We begin with a simple additive model, ignoring the nesting of samples within sites. 

This model includes a smoothed term for time since fire to allow for non-linear effects, with an interaction between time, fire type and depth.

The R code to fit this model is:

```{r echo = TRUE}

mtotal <- gam(log(percentC) ~ s(tsf.years, by = dft, bs = "cr") + 
                fireType + depth + microsite,
              data = DAT,
              method = "REML")

```


Examining model residuals...

```{r}

dat <- data_frame(
  resid = resid(mtotal),
  fitted = fitted(mtotal)
)

ggplot(data = dat) +
  geom_histogram(aes(x = resid), binwidth = 0.1,
                 fill = "grey80", colour = "black") +
  
  labs(x = Labels$res, y = "count") +
  
  GOPTS

```

Checking residuals for normality:

```{r}

qqnorm(dat$resid, main = "Residuals Q-Q plot")
qqline(dat$resid, lty = 2)

```

Plot of residuals against fitted values to check for homogeneity.

```{r}

dat <- cbind(DAT, dat)

ggplot(data = dat, aes(x = fitted, y = resid)) +
  geom_point(size = POINT_SIZE) +

  ZeroLine +
  
  labs(x = Labels$fit, y = Labels$res) +
  
  GOPTS

```

Residuals against co-variates.

```{r}

ggplot(data = dat, aes(x = tsf.years, y = resid)) +
  geom_point(size = POINT_SIZE) +
  
  ZeroLine +
  
  labs(x = Labels$tsf, y = Labels$res) +

  GOPTS +

  facet_grid(depth ~ fireType)

```

```{r}

ggplot(data = dat, aes(x = fireType, y = resid)) +
  
  geom_point(position = position_jitter(width = 0.15),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  ZeroLine +
  
  labs(x = Labels$firetype, y = Labels$res) +
  
  GOPTS +
  
  facet_wrap( ~ depth)

```

```{r}

ggplot(data = dat, aes(x = microsite, y = resid)) +
  
  geom_point(position = position_jitter(width = 0.15),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  ZeroLine +
  
  labs(x = Labels$microsite, y = Labels$res) +
  
  GOPTS +
  
  facet_wrap( ~ depth)

```

Plot of residuals against sites to check for any systematic patterns and assess our decision to ignore any correlation of responses within sites in the initial model.

To make any pattern easier to see, sites are arranged on the X-axis in ascending order of mean residual value within site.

```{r}

# Order the sites by mean residual value
site.order <- dat %>%
  group_by(fSiteId) %>%
  summarize(rmean = mean(resid)) %>%
  arrange(rmean) %>%
  mutate(order = row_number())

dat2 <- left_join(dat, site.order)

ggplot(data = dat2, aes(x = order, y = resid)) +
  geom_point() +
  FireTypeColour +
  
  ZeroLine +
  
  scale_x_discrete(labels = NULL) +
  
  labs(x = Labels$site.by.res, y = Labels$res) +
  
  GOPTS

```

The plot shows that residuals are not independent across sites. We confirm this by regressing residuals on site:

```{r}

anova(lm(resid ~ fSiteId, data = dat))

```



### Second model incorporating site random effect

Here we add a random-effect smoother to the model to account for site differences. Rather than using a formal generalized additive mixed model (with functions `gamm` or `gamm4`) we follow 
[this advice from Simon Wood](http://r.789695.n4.nabble.com/mgcv-gamm-predict-to-reflect-random-s-effects-tp3622738p3622865.html) (author of the mgcv package) to use the standard `gam` function and include a random-effect smoother for site with a binary flag variable. Setting the flag to 1 for model fitting includes the site term, while setting it to 0 for model prediction gives overall predicted means and intervals.


```{r echo = TRUE}

dat <- DAT
dat$flag <- 1

mtotal.site <- gam(log(percentC) ~ s(tsf.years, by = dft, bs = "cr") + 
                     fireType + depth + microsite + 
                     s(fSiteId, bs = "re", by = flag),
                   data = dat,
                   method = "REML")

```

Once again we plot the residuals against sites ordered in the same manner as before.

```{r}

dat$resid <- resid(mtotal.site)
dat$fitted <- fitted(mtotal.site)

site.order <- dat %>%
  group_by(fSiteId) %>%
  summarize(rmean = mean(resid)) %>%
  arrange(rmean) %>%
  mutate(order = row_number())

dat2 <- left_join(dat, site.order)

ggplot(data = dat2, aes(x = order, y = resid)) +
  geom_point() +
  ZeroLine +
  
  scale_x_discrete(labels = NULL) +
  
  labs(x = Labels$site.by.res, y = Labels$res) +
  GOPTS

```

Residuals now appear independent across sites.  We confirm this by repeating the regression:

```{r}

anova(lm(resid ~ fSiteId, data = dat))

```

Checking for normality of residuals:

```{r}

qqnorm(dat$resid, main = "Residual Q-Q plot")
qqline(dat$resid)

```


Comparing the two models with AIC:

```{r}

AIC(mtotal, mtotal.site)

```

The second model, incorporating site random effects, is clearly preferred.

Summary of the fitted model:

```{r}

summary(mtotal.site)

```


### Model predictions

```{r}

# Add flag variable to turn off random site effects, plus
# a dummy site ID (to keep predict.gam happy)

dat.predict <- cbind(
  DAT.predict,
  flag = 0,
  fSiteId = levels(DAT$fSiteId)[1]
)

fit <- do_predict(mtotal.site, dat.predict, "percentC", exp)

ggplot(data = fit, aes(x = tsf.years, y = percentC)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = fireType), alpha = 0.3) +
  geom_path(aes(colour = fireType), size = 1.5) +
  
  geom_point(data = DAT, aes(colour = fireType)) +
  
  FireTypeColour +
  scale_fill_discrete(name = Labels$firetype) +
  
  labs(x = Labels$tsf, y = Labels$percentC) +
  
  facet_grid(depth ~ microsite, scales = "fixed") +
  GOPTS

```


## Recalcitrant pyrogenic carbon

For RPC, we are interested in the absolute value within samples as well as the fraction of total carbon in the form of RPC. Here we begin with a model of the absolute values, controlling for the amount of total carbon in the sample by including that as a co-variate.


### Data exploration

The following dot plot shows percent carbon for all samples. Sites are ordered by fire type, then site ID value (integer: 1 - 33).

```{r}

ggplot(data = DAT, aes(x = percentRPC, y = ftOrder)) +
  geom_hline(yintercept = 1:NSITES, colour = "grey80") +
  
  geom_point(aes(colour = fireType), size = POINT_SIZE) +
  
  FireTypeColour +
  
  scale_x_continuous(limits = c(0, NA),
                     breaks = waiver(), 
                     minor_breaks = NULL) +
  
  scale_y_discrete(breaks = NULL, labels = NULL) +
  
  labs(x = Labels$percentRPC, y = Labels$sitesFT) +
  
  GOPTS +
  
  facet_wrap(~ depth)

```


```{r}

last_plot() + 
  facet_grid(depth ~ microsite)

```


Distribution of values with respect to fire type and microsite.

```{r}

ggplot(data = DAT, aes(x = microsite, y = percentRPC)) +
  geom_point(aes(colour = fireType), 
             position = position_jitterdodge(),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  labs(x = Labels$microsite, y = Labels$percentRPC) +
  
  GOPTS +
  
  facet_wrap(~ depth)

```



Relative to time since fire.

```{r}

ggplot(data = DAT, aes(x = tsf.years, y = percentRPC)) +
  geom_point(aes(colour = fireType),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  labs(x = Labels$tsf, y = Labels$percentRPC) +

  GOPTS +
  
  facet_wrap(~ depth)

```


```{r}

last_plot() +
  facet_grid(depth ~ microsite)

```


### Model

The form of the model follows that used for total carbon as the response, the only modification being the inclusion of total carbon as a co-variate to control for its effect on the level of recalcitrant carbon.

```{r echo = TRUE}

dat <- DAT
dat$flag <- 1

mrpc <- gam(log(percentRPC) ~ s(tsf.years, by = dft, bs = "cr") + 
              fireType + depth + microsite +
              s(percentC) +
              s(fSiteId, bs = "re", by = flag),
            data = dat,
            method = "REML")

```

Check residuals against sites ordered in the same manner as for the percent carbon model.

```{r}

dat$resid <- resid(mrpc)
dat$fitted <- fitted(mrpc)

site.order <- dat %>%
  group_by(fSiteId) %>%
  summarize(rmean = mean(resid)) %>%
  arrange(rmean) %>%
  mutate(order = row_number())

dat2 <- left_join(dat, site.order)

ggplot(data = dat2, aes(x = order, y = resid)) +
  geom_point() +
  ZeroLine +
  
  scale_x_discrete(labels = NULL) +
  
  labs(x = Labels$site.by.res, y = Labels$res) +
  GOPTS

```

No obvious pattern of residuals across sites. Check with anova:

```{r}

anova(lm(resid ~ fSiteId, data = dat))

```

Checking for normality of residuals:

```{r}

qqnorm(dat$resid, main = "Residual Q-Q plot")
qqline(dat$resid)

```

All looks good except for the single sample with a large negative value. Investigating this sample:

```{r}

outlier <- filter(dat, resid < -4) %>%
  select(siteId, fireType, depth, microsite) %>%
  left_join(DAT) %>%
  select(sampleIndex, siteLabel, fireType, depth, microsite, tsf.years, percentC, percentRPC)

knitr::kable(outlier)

```


The offender is sample number 166. Its value of RPC is very low compared to the other two replicates. Checked with Robert and he suggests that this was most likely a problem with the digestion. The sample will have had little influence on the model, but to be safe we discard it and re-run...

```{r echo = TRUE}

DAT <- filter(DAT, sampleIndex != 166)

dat <- DAT
dat$flag <- 1

mrpc <- gam(log(percentRPC) ~ s(tsf.years, by = dft, bs = "cr") + 
            fireType + depth + microsite +
            s(percentC) +
            s(fSiteId, bs = "re", by = flag),
          data = dat,
          method = "REML")

```

Re-check the residuals:

```{r}

dat$resid <- resid(mrpc)
dat$fitted <- fitted(mrpc)

qqnorm(dat$resid, main = "Residual Q-Q plot")
qqline(dat$resid)

```


Summary of the fitted model:

```{r}

summary(mrpc)

```

### Shape of the effect of total carbon

Total carbon was fitted as a smooth term. Its estimated degrees of freedom (~ 5.2) indicate it is non-linear. The plot below shows the shape of the fitted smooth function for total carbon:

```{r}

plot(mrpc, select = 5)

```
It is likely that the function is strongly influenced by the three samples with high total carbon values. However, fitting the model again with these samples down-weighted produced a similarly shaped smoother.

### Model predictions

Within each combination of fire type, depth and micro-site, we derive predictions over times since fire based on the median value of total carbon. 


```{r}

dat.predict <- cbind(
  DAT.predict,
  flag = 0,
  fSiteId = levels(DAT$fSiteId)[1]
)

Cmeans <- DAT %>%
  group_by(fireType, depth, microsite) %>%
  summarize(percentC = median(percentC))

dat.predict <- left_join(dat.predict, Cmeans)

fit <- do_predict(mrpc, dat.predict, "percentRPC", exp)

ggplot(data = fit, aes(x = tsf.years, y = percentRPC)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = fireType), alpha = 0.3) +
  geom_path(aes(colour = fireType), size = 1.5) +
  
  geom_point(data = DAT, aes(colour = fireType)) +
  
  FireTypeColour +
  scale_fill_discrete(name = Labels$firetype) +
  
  labs(x = Labels$tsf, y = Labels$percentRPC) +
  
  facet_grid(depth ~ microsite) +
  GOPTS

```


## Proportion of recalcitrant pyrogenic carbon

Here we fit a similar model, but with the response being RPC as a proportion of total carbon.

### Data exploration

```{r}

ggplot(data = DAT, aes(x = propRPC, y = ftOrder)) +
  geom_hline(yintercept = 1:NSITES, colour = "grey80") +
  
  geom_point(aes(colour = fireType), size = POINT_SIZE) +
  
  FireTypeColour +
  
  scale_x_continuous(limits = c(0, NA),
                     breaks = waiver(), 
                     minor_breaks = NULL) +
  
  scale_y_discrete(breaks = NULL, labels = NULL) +
  
  labs(x = Labels$propRPC, y = Labels$sitesFT) +
  
  GOPTS +
  
  facet_wrap(~ depth)

```


```{r}

last_plot() + 
  facet_grid(depth ~ microsite)

```


Distribution of values with respect to fire type and microsite.

```{r}

ggplot(data = DAT, aes(x = microsite, y = propRPC)) +
  geom_point(aes(colour = fireType), 
             position = position_jitterdodge(),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  labs(x = Labels$microsite, y = Labels$propRPC) +
  
  GOPTS +
  
  facet_wrap(~ depth)

```



Relative to time since fire.

```{r}

ggplot(data = DAT, aes(x = tsf.years, y = propRPC)) +
  geom_point(aes(colour = fireType),
             size = POINT_SIZE) +
  
  FireTypeColour +
  
  labs(x = Labels$tsf, y = Labels$propRPC) +

  GOPTS +
  
  facet_wrap(~ depth)

```


```{r}

last_plot() +
  facet_grid(depth ~ microsite)

```

### Model

```{r echo = TRUE}

dat <- DAT
dat$flag <- 1

mrpc.prop <- gam(log(propRPC) ~ s(tsf.years, by = dft, bs = "cr") + 
                   fireType + depth + microsite +
                   s(fSiteId, bs = "re", by = flag),
                 data = dat,
                 method = "REML")

```


Check residuals against sites ordered in the same manner as for the percent carbon model.

```{r}

dat$resid <- resid(mrpc.prop)
dat$fitted <- fitted(mrpc.prop)

site.order <- dat %>%
  group_by(fSiteId) %>%
  summarize(rmean = mean(resid)) %>%
  arrange(rmean) %>%
  mutate(order = row_number())

dat2 <- left_join(dat, site.order)

ggplot(data = dat2, aes(x = order, y = resid)) +
  geom_point() +
  ZeroLine +
  
  scale_x_discrete(labels = NULL) +
  
  labs(x = Labels$site.by.res, y = Labels$res) +
  GOPTS

```

Once again there is an outlier residual for the sample with a very low RPC value.

Checking for normality of residuals:

```{r}

qqnorm(dat$resid, main = "Residual Q-Q plot")
qqline(dat$resid)

```

Summary of the fitted model:

```{r}

summary(mrpc.prop)

```

### Model predictions

```{r}

dat.predict <- cbind(
  DAT.predict,
  flag = 0,
  fSiteId = levels(DAT$fSiteId)[1]
)

fit <- do_predict(mrpc.prop, dat.predict, "propRPC", exp)

ggplot(data = fit, aes(x = tsf.years, y = propRPC)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = fireType), alpha = 0.3) +
  geom_path(aes(colour = fireType), size = 1.5) +
  
  geom_point(data = DAT, aes(colour = fireType)) +
  
  FireTypeColour +
  scale_fill_discrete(name = Labels$firetype) +
  
  labs(x = Labels$tsf, y = Labels$propRPC) +
  
  facet_grid(depth ~ microsite) +
  GOPTS

```

